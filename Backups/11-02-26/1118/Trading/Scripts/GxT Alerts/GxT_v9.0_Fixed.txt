//@version=6
indicator("GxT Alerts - C2 + Order Flow", shorttitle="GxT C2/Flow", overlay=true, max_bars_back=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GxT ALERTS - C2 DETECTION + ORDER FLOW TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

group_tf = "Timeframes"
show_4h_c2 = input.bool(true, "4H C2 Alerts", group=group_tf)
show_1h_c2 = input.bool(true, "1H C2 Alerts", group=group_tf)
show_30m_c2 = input.bool(true, "30M C2 Alerts", group=group_tf)

group_table = "Order Flow Table"
show_table = input.bool(true, "Show Order Flow Table", group=group_table)
table_position = input.string("Top Right", "Position", options=["Top Right", "Top Left", "Bottom Right", "Bottom Left"], group=group_table)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

getHTFData(tf) =>
    htf_open = request.security(syminfo.tickerid, tf, open, lookahead=barmerge.lookahead_off)
    htf_high = request.security(syminfo.tickerid, tf, high, lookahead=barmerge.lookahead_off)
    htf_low = request.security(syminfo.tickerid, tf, low, lookahead=barmerge.lookahead_off)
    htf_close = request.security(syminfo.tickerid, tf, close, lookahead=barmerge.lookahead_off)
    [htf_open, htf_high, htf_low, htf_close]

// C2 Detection: ANY wick outside C1 + close inside
isC2(c1_high, c1_low, c2_high, c2_low, c2_close) =>
    bull_c2 = c2_low < c1_low and c2_close > c1_low and c2_close < c1_high
    bear_c2 = c2_high > c1_high and c2_close < c1_high and c2_close > c1_low
    bull_c2 ? 1 : bear_c2 ? -1 : 0

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[htf_4h_o, htf_4h_h, htf_4h_l, htf_4h_c] = getHTFData("240")
[htf_1h_o, htf_1h_h, htf_1h_l, htf_1h_c] = getHTFData("60")
[htf_30m_o, htf_30m_h, htf_30m_l, htf_30m_c] = getHTFData("30")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// C2 DETECTION - Working v7.0 logic
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// 4H C2
var int c2_4h_dir = 0
if barstate.isconfirmed and show_4h_c2
    c2_4h_dir := isC2(htf_4h_h[1], htf_4h_l[1], htf_4h_h, htf_4h_l, htf_4h_c)

// 1H C2
var int c2_1h_dir = 0
if barstate.isconfirmed and show_1h_c2
    c2_1h_dir := isC2(htf_1h_h[1], htf_1h_l[1], htf_1h_h, htf_1h_l, htf_1h_c)

// 30M C2
var int c2_30m_dir = 0
if barstate.isconfirmed and show_30m_c2
    c2_30m_dir := isC2(htf_30m_h[1], htf_30m_l[1], htf_30m_h, htf_30m_l, htf_30m_c)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLOTTING - C2 LABELS ONLY (Fixed)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// 4H C2
plotshape(show_4h_c2 and c2_4h_dir == 1, title="4H C2 Bull", location=location.belowbar, color=color.new(color.orange, 50), style=shape.labelup, size=size.normal, text="4H")
plotshape(show_4h_c2 and c2_4h_dir == -1, title="4H C2 Bear", location=location.abovebar, color=color.new(color.orange, 50), style=shape.labeldown, size=size.normal, text="4H")

// 1H C2
plotshape(show_1h_c2 and c2_1h_dir == 1, title="1H C2 Bull", location=location.belowbar, color=color.yellow, style=shape.labelup, size=size.small, text="1H")
plotshape(show_1h_c2 and c2_1h_dir == -1, title="1H C2 Bear", location=location.abovebar, color=color.yellow, style=shape.labeldown, size=size.small, text="1H")

// 30M C2
plotshape(show_30m_c2 and c2_30m_dir == 1, title="30M C2 Bull", location=location.belowbar, color=color.new(color.yellow, 30), style=shape.labelup, size=size.tiny, text="30M")
plotshape(show_30m_c2 and c2_30m_dir == -1, title="30M C2 Bear", location=location.abovebar, color=color.new(color.yellow, 30), style=shape.labeldown, size=size.tiny, text="30M")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(show_1h_c2 and c2_1h_dir == 1, title="1H Bullish C2", message="ðŸŸ¡ 1H BULLISH C2 - Prepare for C3")
alertcondition(show_1h_c2 and c2_1h_dir == -1, title="1H Bearish C2", message="ðŸŸ¡ 1H BEARISH C2 - Prepare for C3")
alertcondition(show_30m_c2 and c2_30m_dir == 1, title="30M Bullish C2", message="ðŸŸ¡ 30M BULLISH C2 - Prepare for C3")
alertcondition(show_30m_c2 and c2_30m_dir == -1, title="30M Bearish C2", message="ðŸŸ¡ 30M BEARISH C2 - Prepare for C3")
alertcondition(show_4h_c2 and c2_4h_dir == 1, title="4H Bullish C2", message="ðŸŸ  4H BULLISH C2 - Check wick size for entry decision")
alertcondition(show_4h_c2 and c2_4h_dir == -1, title="4H Bearish C2", message="ðŸŸ  4H BEARISH C2 - Check wick size for entry decision")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIMPLE ORDER FLOW TABLE (Based on most recent C2 direction)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

table_pos = table_position == "Top Right" ? position.top_right : table_position == "Top Left" ? position.top_left : table_position == "Bottom Right" ? position.bottom_right : position.bottom_left

var table flow_table = table.new(table_pos, 2, 4, bgcolor=color.new(color.black, 80), border_width=1, border_color=color.gray)

// Count aligned timeframes
bull_count = (show_4h_c2 and c2_4h_dir == 1 ? 1 : 0) + (show_1h_c2 and c2_1h_dir == 1 ? 1 : 0) + (show_30m_c2 and c2_30m_dir == 1 ? 1 : 0)
bear_count = (show_4h_c2 and c2_4h_dir == -1 ? 1 : 0) + (show_1h_c2 and c2_1h_dir == -1 ? 1 : 0) + (show_30m_c2 and c2_30m_dir == -1 ? 1 : 0)
total_tf = (show_4h_c2 ? 1 : 0) + (show_1h_c2 ? 1 : 0) + (show_30m_c2 ? 1 : 0)

alignment_color = bull_count == total_tf and total_tf > 0 ? color.green : bear_count == total_tf and total_tf > 0 ? color.red : color.gray
alignment_text = bull_count == total_tf and total_tf > 0 ? "ðŸŸ¢ ALIGNED" : bear_count == total_tf and total_tf > 0 ? "ðŸ”´ ALIGNED" : "âšª MIXED"

if barstate.islast and show_table
    table.cell(flow_table, 0, 0, "TF", text_color=color.white, text_size=size.small)
    table.cell(flow_table, 1, 0, "C2 Status", text_color=color.white, text_size=size.small)
    
    row = 1
    if show_4h_c2
        table.cell(flow_table, 0, row, "4H", text_color=color.white, text_size=size.small)
        table.cell(flow_table, 1, row, c2_4h_dir == 1 ? "ðŸŸ¢ BULL" : c2_4h_dir == -1 ? "ðŸ”´ BEAR" : "âšª â€”", 
                  text_color=c2_4h_dir == 1 ? color.green : c2_4h_dir == -1 ? color.red : color.gray, text_size=size.small)
        row += 1
    
    if show_1h_c2
        table.cell(flow_table, 0, row, "1H", text_color=color.white, text_size=size.small)
        table.cell(flow_table, 1, row, c2_1h_dir == 1 ? "ðŸŸ¢ BULL" : c2_1h_dir == -1 ? "ðŸ”´ BEAR" : "âšª â€”", 
                  text_color=c2_1h_dir == 1 ? color.green : c2_1h_dir == -1 ? color.red : color.gray, text_size=size.small)
        row += 1
    
    if show_30m_c2
        table.cell(flow_table, 0, row, "30M", text_color=color.white, text_size=size.small)
        table.cell(flow_table, 1, row, c2_30m_dir == 1 ? "ðŸŸ¢ BULL" : c2_30m_dir == -1 ? "ðŸ”´ BEAR" : "âšª â€”", 
                  text_color=c2_30m_dir == 1 ? color.green : c2_30m_dir == -1 ? color.red : color.gray, text_size=size.small)

// Summary label
var label align_label = na
if barstate.islast
    label.delete(align_label)
    align_label := label.new(bar_index, low, text=alignment_text, color=alignment_color, 
                            textcolor=color.white, style=label.style_label_upper_right, 
                            size=size.small, yloc=yloc.belowbar)
