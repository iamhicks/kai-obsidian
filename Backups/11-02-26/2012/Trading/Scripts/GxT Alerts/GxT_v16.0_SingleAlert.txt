//@version=6
indicator("GxT Alerts - C2 Detector", shorttitle="GxT C2", overlay=true, max_bars_back=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GxT ALERTS - C2 DETECTOR (Single Alert + Fixed Labels)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

group_tf = "Enable Alerts (Check which C2 types to alert on)"
enable_4h_c2 = input.bool(true, "4H C2 Alert", group=group_tf)
enable_1h_std_c2 = input.bool(true, "1H Standard C2 Alert", group=group_tf)
enable_1h_strong_c2 = input.bool(true, "1H Strong C2 Alert", group=group_tf)
enable_30m_std_c2 = input.bool(true, "30M Standard C2 Alert", group=group_tf)
enable_30m_strong_c2 = input.bool(true, "30M Strong C2 Alert", group=group_tf)

group_time = "Time Window (EST)"
use_time_window = input.bool(false, "Only alert during time window", group=group_time)
start_hour_est = input.int(8, "Start Hour (EST)", minval=0, maxval=23, group=group_time)
start_minute_est = input.int(0, "Start Minute", minval=0, maxval=59, group=group_time)
end_hour_est = input.int(16, "End Hour (EST)", minval=0, maxval=23, group=group_time)
end_minute_est = input.int(0, "End Minute", minval=0, maxval=59, group=group_time)

group_table = "Table"
show_table = input.bool(true, "Show C2 Table", group=group_table)
table_position = input.string("Top Right", "Position", options=["Top Right", "Top Left", "Bottom Right", "Bottom Left"], group=group_table)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIME WINDOW CHECK (EST)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

current_hour_est = hour(time, "America/New_York")
current_minute_est = minute(time, "America/New_York")
current_time_minutes_est = current_hour_est * 60 + current_minute_est
start_time_minutes_est = start_hour_est * 60 + start_minute_est
end_time_minutes_est = end_hour_est * 60 + end_minute_est

// Handle overnight windows
if end_time_minutes_est < start_time_minutes_est
    end_time_minutes_est := end_time_minutes_est + 1440
    if current_time_minutes_est < start_time_minutes_est
        current_time_minutes_est := current_time_minutes_est + 1440

in_time_window_est = use_time_window ? (current_time_minutes_est >= start_time_minutes_est and current_time_minutes_est <= end_time_minutes_est) : true

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

getHTFData(tf) =>
    htf_open = request.security(syminfo.tickerid, tf, open, lookahead=barmerge.lookahead_off)
    htf_high = request.security(syminfo.tickerid, tf, high, lookahead=barmerge.lookahead_off)
    htf_low = request.security(syminfo.tickerid, tf, low, lookahead=barmerge.lookahead_off)
    htf_close = request.security(syminfo.tickerid, tf, close, lookahead=barmerge.lookahead_off)
    [htf_open, htf_high, htf_low, htf_close]

// C2 Detection: Wick outside C1 + close valid (inside or beyond)
isValidC2(c1_high, c1_low, c2_high, c2_low, c2_close) =>
    // Bullish C2: Wick below C1 low, close above C1 low
    bull_c2 = c2_low < c1_low and c2_close > c1_low
    // Bearish C2: Wick above C1 high, close below C1 high
    bear_c2 = c2_high > c1_high and c2_close < c1_high
    bull_c2 ? 1 : bear_c2 ? -1 : 0

// C2 type: Standard (close inside) or Strong (close beyond)
c2Type(c1_high, c1_low, c2_close) =>
    close_inside = c2_close > c1_low and c2_close < c1_high
    close_beyond = c2_close > c1_high or c2_close < c1_low
    close_inside ? "Std" : close_beyond ? "Strong" : ""

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[htf_4h_o, htf_4h_h, htf_4h_l, htf_4h_c] = getHTFData("240")
[htf_1h_o, htf_1h_h, htf_1h_l, htf_1h_c] = getHTFData("60")
[htf_30m_o, htf_30m_h, htf_30m_l, htf_30m_c] = getHTFData("30")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// C2 DETECTION ON EACH BAR (Store results)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Detect 4H C2
var int c2_4h_dir = 0
var string c2_4h_type = ""
var bool new_4h_c2_bull = false
var bool new_4h_c2_bear = false

if barstate.isconfirmed
    c2_4h_dir := isValidC2(htf_4h_h[1], htf_4h_l[1], htf_4h_h, htf_4h_l, htf_4h_c)
    c2_4h_type := c2_4h_dir != 0 ? c2Type(htf_4h_h[1], htf_4h_l[1], htf_4h_c) : ""
    new_4h_c2_bull := c2_4h_dir == 1
    new_4h_c2_bear := c2_4h_dir == -1
else
    new_4h_c2_bull := false
    new_4h_c2_bear := false

// Detect 1H C2
var int c2_1h_dir = 0
var string c2_1h_type = ""
var bool new_1h_c2_bull = false
var bool new_1h_c2_bear = false

if barstate.isconfirmed
    c2_1h_dir := isValidC2(htf_1h_h[1], htf_1h_l[1], htf_1h_h, htf_1h_l, htf_1h_c)
    c2_1h_type := c2_1h_dir != 0 ? c2Type(htf_1h_h[1], htf_1h_l[1], htf_1h_c) : ""
    new_1h_c2_bull := c2_1h_dir == 1
    new_1h_c2_bear := c2_1h_dir == -1
else
    new_1h_c2_bull := false
    new_1h_c2_bear := false

// Detect 30M C2
var int c2_30m_dir = 0
var string c2_30m_type = ""
var bool new_30m_c2_bull = false
var bool new_30m_c2_bear = false

if barstate.isconfirmed
    c2_30m_dir := isValidC2(htf_30m_h[1], htf_30m_l[1], htf_30m_h, htf_30m_l, htf_30m_c)
    c2_30m_type := c2_30m_dir != 0 ? c2Type(htf_30m_h[1], htf_30m_l[1], htf_30m_c) : ""
    new_30m_c2_bull := c2_30m_dir == 1
    new_30m_c2_bear := c2_30m_dir == -1
else
    new_30m_c2_bull := false
    new_30m_c2_bear := false

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SINGLE CONSOLIDATED ALERT (Combines all enabled C2 types)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Build alert message based on what triggered
alert_msg = ""

// Check 4H
if enable_4h_c2 and new_4h_c2_bull and in_time_window_est
    alert_msg := "ğŸŸ  4H BULLISH C2 - Liquidity swept. Prepare for C3 entry."
else if enable_4h_c2 and new_4h_c2_bear and in_time_window_est
    alert_msg := "ğŸŸ  4H BEARISH C2 - Liquidity swept. Prepare for C3 entry."

// Check 1H Standard
else if enable_1h_std_c2 and new_1h_c2_bull and c2_1h_type == "Std" and in_time_window_est
    alert_msg := "ğŸŸ¡ 1H STANDARD C2 BULL - Wait for C3 entry on next candle."
else if enable_1h_std_c2 and new_1h_c2_bear and c2_1h_type == "Std" and in_time_window_est
    alert_msg := "ğŸŸ¡ 1H STANDARD C2 BEAR - Wait for C3 entry on next candle."

// Check 1H Strong
else if enable_1h_strong_c2 and new_1h_c2_bull and c2_1h_type == "Strong" and in_time_window_est
    alert_msg := "ğŸŸ  1H STRONG C2 BULL - Expansion shown! Prepare for entry."
else if enable_1h_strong_c2 and new_1h_c2_bear and c2_1h_type == "Strong" and in_time_window_est
    alert_msg := "ğŸŸ  1H STRONG C2 BEAR - Expansion shown! Prepare for entry."

// Check 30M Standard
else if enable_30m_std_c2 and new_30m_c2_bull and c2_30m_type == "Std" and in_time_window_est
    alert_msg := "ğŸŸ¡ 30M STANDARD C2 BULL - Wait for C3 entry."
else if enable_30m_std_c2 and new_30m_c2_bear and c2_30m_type == "Std" and in_time_window_est
    alert_msg := "ğŸŸ¡ 30M STANDARD C2 BEAR - Wait for C3 entry."

// Check 30M Strong
else if enable_30m_strong_c2 and new_30m_c2_bull and c2_30m_type == "Strong" and in_time_window_est
    alert_msg := "ğŸŸ  30M STRONG C2 BULL - Expansion shown! Prepare for entry."
else if enable_30m_strong_c2 and new_30m_c2_bear and c2_30m_type == "Strong" and in_time_window_est
    alert_msg := "ğŸŸ  30M STRONG C2 BEAR - Expansion shown! Prepare for entry."

// Single alert condition that fires if any enabled C2 is detected
any_c2_detected = (enable_4h_c2 and (new_4h_c2_bull or new_4h_c2_bear)) or
                  (enable_1h_std_c2 and (new_1h_c2_bull or new_1h_c2_bear) and c2_1h_type == "Std") or
                  (enable_1h_strong_c2 and (new_1h_c2_bull or new_1h_c2_bear) and c2_1h_type == "Strong") or
                  (enable_30m_std_c2 and (new_30m_c2_bull or new_30m_c2_bear) and c2_30m_type == "Std") or
                  (enable_30m_strong_c2 and (new_30m_c2_bull or new_30m_c2_bear) and c2_30m_type == "Strong")

alertcondition(any_c2_detected and in_time_window_est, title="GxT C2 Alert", message=alert_msg)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLOTTING - Labels on chart
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// 4H C2 labels
plotshape(new_4h_c2_bull, title="4H C2 Bull", location=location.belowbar, color=color.new(color.orange, 50), style=shape.labelup, size=size.normal, text="4H")
plotshape(new_4h_c2_bear, title="4H C2 Bear", location=location.abovebar, color=color.new(color.orange, 50), style=shape.labeldown, size=size.normal, text="4H")

// 1H C2 labels
plotshape(new_1h_c2_bull and c2_1h_type == "Std", title="1H Std C2 Bull", location=location.belowbar, color=color.yellow, style=shape.labelup, size=size.small, text="1H")
plotshape(new_1h_c2_bear and c2_1h_type == "Std", title="1H Std C2 Bear", location=location.abovebar, color=color.yellow, style=shape.labeldown, size=size.small, text="1H")
plotshape(new_1h_c2_bull and c2_1h_type == "Strong", title="1H Strong C2 Bull", location=location.belowbar, color=color.orange, style=shape.labelup, size=size.normal, text="1Hâ˜…")
plotshape(new_1h_c2_bear and c2_1h_type == "Strong", title="1H Strong C2 Bear", location=location.abovebar, color=color.orange, style=shape.labeldown, size=size.normal, text="1Hâ˜…")

// 30M C2 labels
plotshape(new_30m_c2_bull and c2_30m_type == "Std", title="30M Std C2 Bull", location=location.belowbar, color=color.new(color.yellow, 30), style=shape.labelup, size=size.tiny, text="30M")
plotshape(new_30m_c2_bear and c2_30m_type == "Std", title="30M Std C2 Bear", location=location.abovebar, color=color.new(color.yellow, 30), style=shape.labeldown, size=size.tiny, text="30M")
plotshape(new_30m_c2_bull and c2_30m_type == "Strong", title="30M Strong C2 Bull", location=location.belowbar, color=color.new(color.orange, 30), style=shape.labelup, size=size.small, text="30Mâ˜…")
plotshape(new_30m_c2_bear and c2_30m_type == "Strong", title="30M Strong C2 Bear", location=location.abovebar, color=color.new(color.orange, 30), style=shape.labeldown, size=size.small, text="30Mâ˜…")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

table_pos = table_position == "Top Right" ? position.top_right : table_position == "Top Left" ? position.top_left : table_position == "Bottom Right" ? position.bottom_right : position.bottom_left

var table c2_table = table.new(table_pos, 2, 4, bgcolor=color.new(color.black, 80), border_width=1, border_color=color.gray)

if barstate.islast and show_table
    table.cell(c2_table, 0, 0, "TF", text_color=color.white, text_size=size.small)
    table.cell(c2_table, 1, 0, "C2 Status", text_color=color.white, text_size=size.small)
    
    row = 1
    
    if enable_4h_c2
        c2_txt_4h = c2_4h_dir == 1 ? "ğŸŸ¢ BULL" : c2_4h_dir == -1 ? "ğŸ”´ BEAR" : "â€”"
        c2_col_4h = c2_4h_dir == 1 ? color.green : c2_4h_dir == -1 ? color.red : color.gray
        table.cell(c2_table, 0, row, "4H", text_color=color.white, text_size=size.small)
        table.cell(c2_table, 1, row, c2_txt_4h, text_color=c2_col_4h, text_size=size.small)
        row += 1
    
    if enable_1h_std_c2 or enable_1h_strong_c2
        type_txt = c2_1h_type == "Strong" ? " â˜…" : ""
        c2_txt_1h = c2_1h_dir == 1 ? "ğŸŸ¡ BULL" + type_txt : c2_1h_dir == -1 ? "ğŸŸ¡ BEAR" + type_txt : "â€”"
        c2_col_1h = c2_1h_dir != 0 ? color.yellow : color.gray
        table.cell(c2_table, 0, row, "1H", text_color=color.white, text_size=size.small)
        table.cell(c2_table, 1, row, c2_txt_1h, text_color=c2_col_1h, text_size=size.small)
        row += 1
    
    if enable_30m_std_c2 or enable_30m_strong_c2
        type_txt = c2_30m_type == "Strong" ? " â˜…" : ""
        c2_txt_30m = c2_30m_dir == 1 ? "ğŸŸ¡ BULL" + type_txt : c2_30m_dir == -1 ? "ğŸŸ¡ BEAR" + type_txt : "â€”"
        c2_col_30m = c2_30m_dir != 0 ? color.yellow : color.gray
        table.cell(c2_table, 0, row, "30M", text_color=color.white, text_size=size.small)
        table.cell(c2_table, 1, row, c2_txt_30m, text_color=c2_col_30m, text_size=size.small)
